<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>NEO Messenger</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app">
        <!-- –®–ê–ü–ö–ê -->
        <div class="header">
            <span class="logo">‚ú® NEO Messenger</span>
            <div id="userMenu" class="user-menu"></div>
        </div>

        <!-- –°–ï–ö–¶–ò–Ø –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò -->
        <div id="authSection" class="auth-section">
            <div class="auth-card">
                <div class="tabs">
                    <button id="tabLogin" class="tab active">–í—Ö–æ–¥</button>
                    <button id="tabRegister" class="tab">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                </div>

                <!-- —Ñ–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
                <div id="formLogin" class="form">
                    <input type="text" id="loginUser" class="input" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                    <input type="password" id="loginPass" class="input" placeholder="–ü–∞—Ä–æ–ª—å">
                    <button id="loginBtn" class="btn">–í–æ–π—Ç–∏</button>
                    <div id="loginMsg" class="msg"></div>
                </div>

                <!-- —Ñ–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
                <div id="formRegister" class="form" style="display: none;">
                    <input type="text" id="regUser" class="input" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                    <input type="password" id="regPass" class="input" placeholder="–ü–∞—Ä–æ–ª—å">
                    <input type="password" id="regConfirm" class="input" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                    <button id="registerBtn" class="btn">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                    <div id="regMsg" class="msg"></div>
                </div>
            </div>
        </div>

        <!-- –ò–ù–¢–ï–†–§–ï–ô–° –ß–ê–¢–ê -->
        <div id="chatInterface" class="chat-interface">
            <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
            <div class="sidebar">
                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ª—é–¥–µ–π...">
                    <div id="searchResults" class="search-results"></div>
                </div>
                <div id="chatsList" class="chats-list"></div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å -->
            <div class="chat-area">
                <div id="chatHeader" class="chat-header" style="display: none;">
                    <div class="back-button" id="backButton" style="display: none;">‚Üê</div>
                    <div class="avatar" id="chatAvatar">?</div>
                    <div class="partner-info">
                        <h3 id="chatPartnerName">–ò–º—è</h3>
                        <p id="chatStatus">–≤ —Å–µ—Ç–∏</p>
                    </div>
                </div>
                <div id="messagesContainer" class="messages-container"></div>
                <div id="inputRow" class="input-row" style="display: none;">
                    <input type="text" id="messageInput" class="chat-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                    <button id="sendMsgBtn" class="send-button">
                        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== –•–†–ê–ù–ò–õ–ò–©–ï ==========
        const USERS_KEY = 'neo_users';
        const MSGS_KEY = 'neo_messages';
        const CURRENT_USER_KEY = 'neo_current_user';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        if (!localStorage.getItem(USERS_KEY)) {
            localStorage.setItem(USERS_KEY, JSON.stringify([]));
        }
        if (!localStorage.getItem(MSGS_KEY)) {
            localStorage.setItem(MSGS_KEY, JSON.stringify([]));
        }

        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let currentUser = null;
        let activeChat = null;
        let allMessages = [];
        let pollingInterval = null;

        // ========== DOM –≠–õ–ï–ú–ï–ù–¢–´ ==========
        const authSection = document.getElementById('authSection');
        const chatInterface = document.getElementById('chatInterface');
        const userMenu = document.getElementById('userMenu');
        
        // –¢–∞–±—ã
        const tabLogin = document.getElementById('tabLogin');
        const tabRegister = document.getElementById('tabRegister');
        const formLogin = document.getElementById('formLogin');
        const formRegister = document.getElementById('formRegister');
        
        // –í—Ö–æ–¥
        const loginUser = document.getElementById('loginUser');
        const loginPass = document.getElementById('loginPass');
        const loginBtn = document.getElementById('loginBtn');
        const loginMsg = document.getElementById('loginMsg');
        
        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        const regUser = document.getElementById('regUser');
        const regPass = document.getElementById('regPass');
        const regConfirm = document.getElementById('regConfirm');
        const registerBtn = document.getElementById('registerBtn');
        const regMsg = document.getElementById('regMsg');
        
        // –ß–∞—Ç
        const chatsList = document.getElementById('chatsList');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const chatHeader = document.getElementById('chatHeader');
        const chatPartnerName = document.getElementById('chatPartnerName');
        const chatAvatar = document.getElementById('chatAvatar');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendMsgBtn = document.getElementById('sendMsgBtn');
        const inputRow = document.getElementById('inputRow');
        const backButton = document.getElementById('backButton');
        const chatArea = document.querySelector('.chat-area');
        const sidebar = document.querySelector('.sidebar');

        // ========== –í–ö–õ–ê–î–ö–ò ==========
        if (tabLogin && tabRegister) {
            tabLogin.addEventListener('click', () => {
                tabLogin.classList.add('active');
                tabRegister.classList.remove('active');
                formLogin.style.display = 'flex';
                formRegister.style.display = 'none';
                if (loginMsg) loginMsg.textContent = '';
                if (regMsg) regMsg.textContent = '';
            });

            tabRegister.addEventListener('click', () => {
                tabRegister.classList.add('active');
                tabLogin.classList.remove('active');
                formRegister.style.display = 'flex';
                formLogin.style.display = 'none';
                if (loginMsg) loginMsg.textContent = '';
                if (regMsg) regMsg.textContent = '';
            });
        }

        // ========== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ==========
        if (registerBtn) {
            registerBtn.addEventListener('click', () => {
                const username = regUser.value.trim();
                const pass = regPass.value.trim();
                const confirm = regConfirm.value.trim();
                
                if (!username || !pass || !confirm) {
                    regMsg.textContent = '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
                    return;
                }
                if (pass !== confirm) {
                    regMsg.textContent = '‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
                    return;
                }
                
                let users = JSON.parse(localStorage.getItem(USERS_KEY));
                if (users.find(u => u.username === username)) {
                    regMsg.textContent = '‚ùå –ò–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ';
                    return;
                }
                
                users.push({ username, password: pass });
                localStorage.setItem(USERS_KEY, JSON.stringify(users));
                
                regMsg.textContent = '‚úÖ –ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –í–æ–π–¥–∏—Ç–µ.';
                regMsg.style.color = '#a0ffa0';
                
                regUser.value = '';
                regPass.value = '';
                regConfirm.value = '';
                
                setTimeout(() => {
                    if (tabLogin) tabLogin.click();
                }, 1000);
            });
        }

        // ========== –í–•–û–î ==========
        if (loginBtn) {
            loginBtn.addEventListener('click', () => {
                const username = loginUser.value.trim();
                const pass = loginPass.value.trim();
                
                if (!username || !pass) {
                    loginMsg.textContent = '‚ùå –í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –ø–∞—Ä–æ–ª—å';
                    return;
                }
                
                let users = JSON.parse(localStorage.getItem(USERS_KEY));
                let user = users.find(u => u.username === username && u.password === pass);
                
                if (!user) {
                    loginMsg.textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ';
                    return;
                }
                
                currentUser = username;
                localStorage.setItem(CURRENT_USER_KEY, username);
                showChatInterface();
            });
        }

        // ========== –í–´–•–û–î ==========
        function logout() {
            currentUser = null;
            activeChat = null;
            localStorage.removeItem(CURRENT_USER_KEY);
            stopPolling();
            showAuthInterface();
        }

        // ========== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê ==========
        function showAuthInterface() {
            if (authSection) authSection.style.display = 'flex';
            if (chatInterface) chatInterface.style.display = 'none';
            if (userMenu) userMenu.innerHTML = '';
        }

        function showChatInterface() {
            if (authSection) authSection.style.display = 'none';
            if (chatInterface) chatInterface.style.display = 'flex';
            
            const firstLetter = currentUser ? currentUser[0].toUpperCase() : '?';
            if (userMenu) {
                userMenu.innerHTML = `
                    <div class="user-badge">
                        <span class="avatar">${firstLetter}</span>
                        <span style="color:white;">${currentUser}</span>
                    </div>
                    <button id="globalLogoutBtn" class="logout-btn">–í—ã–π—Ç–∏</button>
                `;
                const logoutBtn = document.getElementById('globalLogoutBtn');
                if (logoutBtn) logoutBtn.addEventListener('click', logout);
            }

            loadMessages();
            renderChatsList();
            startPolling();
            
            // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ–º sidebar
            if (isMobile()) {
                if (sidebar) sidebar.style.display = 'flex';
                if (chatArea) chatArea.classList.remove('active');
            }
        }

        // ========== –°–û–û–ë–©–ï–ù–ò–Ø ==========
        function loadMessages() {
            allMessages = JSON.parse(localStorage.getItem(MSGS_KEY)) || [];
        }

        function saveMessages() {
            localStorage.setItem(MSGS_KEY, JSON.stringify(allMessages));
        }

        function getDialogs() {
            if (!currentUser) return [];
            const msgs = allMessages.filter(m => m.from === currentUser || m.to === currentUser);
            const partners = new Set();
            
            msgs.forEach(m => {
                if (m.from === currentUser) partners.add(m.to);
                else partners.add(m.from);
            });
            
            return Array.from(partners).map(p => {
                const last = msgs
                    .filter(m => (m.from === currentUser && m.to === p) || (m.from === p && m.to === currentUser))
                    .sort((a,b) => b.timestamp - a.timestamp)[0];
                return { 
                    username: p, 
                    lastMessage: last?.text || '', 
                    lastTime: last?.time || '' 
                };
            }).sort((a,b) => (b.lastTime || '').localeCompare(a.lastTime || ''));
        }

        function renderChatsList() {
            if (!chatsList) return;
            
            const dialogs = getDialogs();
            chatsList.innerHTML = '';
            
            if (dialogs.length === 0) {
                chatsList.innerHTML = '<div style="color:rgba(255,255,255,0.3); text-align:center; padding:20px;">–ù–µ—Ç —á–∞—Ç–æ–≤. –ù–∞–π–¥–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫.</div>';
                return;
            }
            
            dialogs.forEach(d => {
                const item = document.createElement('div');
                item.className = `chat-item ${activeChat?.username === d.username ? 'active' : ''}`;
                item.innerHTML = `
                    <div class="avatar">${d.username[0].toUpperCase()}</div>
                    <div class="chat-info">
                        <div class="chat-name">${d.username}</div>
                        <div class="last-message">${d.lastMessage.substring(0,30)}${d.lastMessage.length > 30 ? '‚Ä¶' : ''}</div>
                    </div>
                `;
                item.addEventListener('click', () => openChat(d.username));
                chatsList.appendChild(item);
            });
        }

        function openChat(partner) {
            if (!currentUser) return;
            activeChat = { username: partner };
            
            if (chatHeader) chatHeader.style.display = 'flex';
            if (inputRow) inputRow.style.display = 'flex';
            if (chatPartnerName) chatPartnerName.textContent = partner;
            if (chatAvatar) chatAvatar.textContent = partner[0].toUpperCase();
            
            renderMessages(partner);
            renderChatsList();
            
            // –ú–æ–±–∏–ª—å–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
            if (isMobile()) {
                if (sidebar) sidebar.style.display = 'none';
                if (chatArea) chatArea.classList.add('active');
                if (backButton) backButton.style.display = 'flex';
            }
        }

        function renderMessages(partner) {
            if (!messagesContainer || !partner) return;
            
            const msgs = allMessages
                .filter(m => (m.from === currentUser && m.to === partner) || (m.from === partner && m.to === currentUser))
                .sort((a,b) => a.timestamp - b.timestamp);
            
            messagesContainer.innerHTML = '';
            
            if (msgs.length === 0) {
                messagesContainer.innerHTML = '<div style="color:rgba(255,255,255,0.3); text-align:center; margin-top:30px;">–ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>';
                return;
            }
            
            msgs.forEach(m => {
                const isOwn = m.from === currentUser;
                const div = document.createElement('div');
                div.className = `message ${isOwn ? 'own' : ''}`;
                div.innerHTML = `
                    <div class="bubble">${m.text}</div>
                    <div class="meta"><span class="sender">${m.from}</span> <span>${m.time}</span></div>
                `;
                messagesContainer.appendChild(div);
            });
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function sendMessage() {
            if (!activeChat) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç');
                return;
            }
            
            const text = messageInput.value.trim();
            if (!text) return;
            
            const msg = {
                from: currentUser,
                to: activeChat.username,
                text: text,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now()
            };
            
            allMessages.push(msg);
            saveMessages();
            renderMessages(activeChat.username);
            renderChatsList();
            messageInput.value = '';
        }

        if (sendMsgBtn) {
            sendMsgBtn.addEventListener('click', sendMessage);
        }
        
        if (messageInput) {
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
        }

        // ========== –ü–û–ò–°–ö –õ–Æ–î–ï–ô ==========
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                const query = this.value.trim().toLowerCase();
                
                if (!searchResults) return;
                
                if (query.length < 1) {
                    searchResults.classList.remove('active');
                    searchResults.innerHTML = '';
                    return;
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                let users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º: –∏—Å–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∏—â–µ–º –ø–æ –ø–æ–¥—Å—Ç—Ä–æ–∫–µ
                let filtered = users.filter(u => 
                    u.username !== currentUser && 
                    u.username.toLowerCase().includes(query)
                );
                
                if (filtered.length === 0) {
                    searchResults.innerHTML = '<div style="padding:12px; color:rgba(255,255,255,0.5);">üë§ –ù–∏–∫–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                    searchResults.classList.add('active');
                    return;
                }
                
                let html = '';
                filtered.forEach(u => {
                    html += `<div class="user-item" data-username="${u.username}">
                        <span class="avatar" style="background: #1e5a9c;">${u.username[0].toUpperCase()}</span>
                        <span>${u.username}</span>
                    </div>`;
                });
                
                searchResults.innerHTML = html;
                searchResults.classList.add('active');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                document.querySelectorAll('.user-item').forEach(el => {
                    el.addEventListener('click', () => {
                        const partner = el.dataset.username;
                        openChat(partner);
                        searchResults.classList.remove('active');
                        if (searchInput) searchInput.value = '';
                    });
                });
            });
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-box') && searchResults) {
                searchResults.classList.remove('active');
            }
        });

        // ========== –ú–û–ë–ò–õ–¨–ù–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø ==========
        function isMobile() {
            return window.innerWidth <= 768;
        }

        // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
        if (backButton) {
            backButton.addEventListener('click', () => {
                if (sidebar) sidebar.style.display = 'flex';
                if (chatArea) chatArea.classList.remove('active');
                backButton.style.display = 'none';
                activeChat = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ
            });
        }

        // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener('resize', () => {
            if (!isMobile()) {
                // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å—ë
                if (sidebar) sidebar.style.display = 'flex';
                if (chatArea) chatArea.classList.remove('active');
                if (backButton) backButton.style.display = 'none';
            } else {
                // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö, –µ—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º sidebar
                if (!activeChat) {
                    if (sidebar) sidebar.style.display = 'flex';
                    if (chatArea) chatArea.classList.remove('active');
                    if (backButton) backButton.style.display = 'none';
                }
            }
        });

        // ========== –ü–û–õ–õ–ò–ù–ì ==========
        function startPolling() {
            if (pollingInterval) clearInterval(pollingInterval);
            
            pollingInterval = setInterval(() => {
                if (!currentUser) return;
                
                const stored = JSON.parse(localStorage.getItem(MSGS_KEY)) || [];
                if (stored.length !== allMessages.length) {
                    allMessages = stored;
                    if (activeChat) {
                        renderMessages(activeChat.username);
                    }
                    renderChatsList();
                }
            }, 1200);
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        (function init() {
            const saved = localStorage.getItem(CURRENT_USER_KEY);
            if (saved) {
                let users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
                if (users.find(u => u.username === saved)) {
                    currentUser = saved;
                    showChatInterface();
                } else {
                    localStorage.removeItem(CURRENT_USER_KEY);
                    showAuthInterface();
                }
            } else {
                showAuthInterface();
            }
        })();
    </script>
</body>
</html>